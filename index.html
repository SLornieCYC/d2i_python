<!DOCTYPE html>

<html>

  <head>

    <meta charset="UTF-8" />

    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <meta

      name="viewport"

      content="width=device-width, initial-scale=1, shrink-to-fit=no"

    />

    <title>stlite app</title>

    <link

      rel="stylesheet"

      href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.31.0/build/stlite.css"

    />

  </head>

  <body>

    <div id="root"></div>

    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.31.0/build/stlite.js"></script>

    <script>

stlite.mount(

  {

    requirements: ["plotly"], // Packages to install

    entrypoint: "app.py", // The target file of the `streamlit run` command

    files: {

        "app.py": `

 #File downloaded: 'raw.githubusercontent.com/data-to-insight/csc-validator-be-903/main/tests/fake_data/header.csv'

import streamlit as st
import pandas as pd
import plotly.express as px

# Utility functions
def age_band(dob_dt):
    today = pd.to_datetime('today')
    if dob_dt + pd.DateOffset(years=5) > today:
        return '0-5 years'
    elif dob_dt + pd.DateOffset(years=11) > today:
        return '5-11 years'
    elif dob_dt + pd.DateOffset(years=16) > today:
        return '10-15 years'
    else:
        return '16+ years'

def ingress(df):

    df['SEX'] = df['SEX'].map(
        {1:'Male',
         2:'Female'}
    )

    df['DOB'] = pd.to_datetime(df['DOB'], format="%d/%m/%Y", errors='coerce')
    df['AGE_BAND'] = df['DOB'].apply(age_band)
    df['DOB'] = df['DOB'].dt.date
    df.drop(['CHILD', 'UPN', 'MOTHER', 'MC_DOB'], axis=1, inplace=True)

    return df


#Plot functions
def gender_plot(df):
    fig = px.histogram(df, 'SEX', title='903 Gender Breakdown')
    return fig

def age_plot(df):
    fig = px.pie(df, names='AGE_BAND', title='903 Age Breakdown')
    return fig

# Main app code
st.title('903 Header Analysis')

headerfile = st.file_uploader('Choose 903 Header file')

if headerfile:
    unclean_df = pd.read_csv(headerfile)
    df = ingress(unclean_df)

    chosen_ethnicity = st.sidebar.multiselect('Select Ethnicities', 
                                      list(df['ETHNIC'].unique()), 
                                      list(df['ETHNIC'].unique()))

    df = df[df['ETHNIC'].isin(chosen_ethnicity)]

    gender_plot_fig = gender_plot(df)
    age_plot_fig = age_plot(df)

    st.write('Table data')
    st.dataframe(df)
    st.plotly_chart(gender_plot_fig)
    st.plotly_chart(age_plot_fig)


`,

    },

  },

  document.getElementById("root")

);

    </script>

  </body>

</html>